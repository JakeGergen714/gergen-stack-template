name: Promote to Prod

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA (Short) to promote'
        required: true

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  ARTIFACT_BUCKET: ${{ vars.ARTIFACT_BUCKET }}
  
  # API Vars
  EB_ENV_NAME: ${{ vars.PROD_EB_ENV_NAME }}
  EB_APP_NAME: ${{ vars.EB_APP_NAME }}
  
  # Web Vars
  WEB_BUCKET: ${{ vars.PROD_WEB_BUCKET }}
  CF_DIST_ID: ${{ vars.PROD_CF_DIST_ID }}
  API_BASE_URL: ${{ vars.PROD_API_URL }}

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Verify Artifact Exists
        run: echo "Verifying artifact exists for SHA ${{ inputs.commit_sha }} (Simulation)"

  promote:
    needs: verify
    runs-on: ubuntu-latest
    environment: production # Requires GitHub Environment Approval if configured
    steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
        
    # --- Deploy API ---
    - name: Deploy API to Beanstalk (Prod)
      run: |
        SHA="${{ inputs.commit_sha }}"
        VERSION_LABEL="prod-${SHA}"
        
        # Check if version exists, if not create it (re-using artifact)
        if ! aws elasticbeanstalk describe-application-versions --application-name ${{ env.EB_APP_NAME }} --version-labels $VERSION_LABEL | grep -q $VERSION_LABEL; then
          aws elasticbeanstalk create-application-version \
            --application-name ${{ env.EB_APP_NAME }} \
            --version-label $VERSION_LABEL \
            --source-bundle S3Bucket=${{ env.ARTIFACT_BUCKET }},S3Key=backend/${SHA}.jar
        fi
          
        # Update Environment
        aws elasticbeanstalk update-environment \
          --environment-name ${{ env.EB_ENV_NAME }} \
          --version-label $VERSION_LABEL

    # --- Deploy Web ---
    - name: Deploy Web to S3 (Prod)
      run: |
        SHA="${{ inputs.commit_sha }}"
        
        # Download artifact
        aws s3 cp s3://${{ env.ARTIFACT_BUCKET }}/frontend/${SHA}.zip web.zip
        unzip web.zip -d dist
        
        # Generate Config for PROD
        echo "window.ENV = { API_URL: '${{ env.API_BASE_URL }}', ENV_NAME: 'prod' };" > dist/config.js
        
        # Sync to Bucket
        aws s3 sync dist s3://${{ env.WEB_BUCKET }} --delete
        
    - name: Invalidate CloudFront
      run: |
        aws cloudfront create-invalidation --distribution-id ${{ env.CF_DIST_ID }} --paths "/*"
